{{- range $index, $proc := $.Values.app.procs }}
{{- $proc_name := (printf "%s-%s" $.Values.app.name (index $proc "name")) -}}
{{- $proc_port := (index $proc "port") -}}

{{- if $proc_port }}

{{- $proc_command := (index $proc "command") -}}
{{- $proc_host := (index $proc "host") -}}
{{- $service_type := (index $proc "serviceType") -}}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $proc_name }}
  {{- if $proc_host }}
  annotations:
    {{- include "external_dns" $proc_host | indent 4 }}
  {{- end }}
  labels:
    app: {{ $proc_name }}
    chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    release: "{{ $.Release.Name }}"
    heritage: "{{ $.Release.Service }}"
spec:
  type: {{ $service_type }}
  selector:
    app: {{ $proc_name }}
  ports:
  - name: http
    port: {{ $proc_port }}
    targetPort: {{ $proc_port }}
...{{ "\n" }}
{{- end }}
{{- end }}
